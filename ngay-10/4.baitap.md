# Chá»©c nÄƒng authentication, user

<details>
<summary><h3 style="display: inline-block;">1. Viáº¿t api Ä‘Äƒng kÃ½ tÃ i khoáº£n</h3></summary>

POST: `/register`

```json
{
    "name": "string", "required",
    "email": "email", "required",
    "password": "string", "required" , "password rule",
}
```

<h4>Logic: </h4>

1. Táº¡o validate schema Ä‘á»ƒ validate Ä‘áº§u vÃ o

```typescript
export const validateRegisterSchema = Joi.object({
  name: Joi.string().required(),
  password: Joi.required().custom(validatePassowrd),
  email: Joi.string().required().email(),
});
```

2. Táº¡o controller Ä‘á»ƒ Ä‘iá»u hÆ°á»›ng

```typescript
@Post("/register")
@Validate(validateRegisterSchema)
async register(req: Request<RegisterInput>) {
    let user = await this.userService.register(req.body);
    return HttpResponse.success(user);
}
```

3. Táº¡o service Ä‘á»ƒ xá»­ lÃ½ logic

```typescript
public async register(userData: RegisterInput) {
    //1. Kiá»ƒm tra xem email Ä‘Ã£ tá»“n táº¡i trÃªn há»‡ thá»‘ng hay chÆ°a, náº¿u tá»“n táº¡i rá»“i throw Error
    let check = await User.findOne({ email: userData.email });
    if (check) {
      throw "Email nÃ y Ä‘Ã£ tá»“n táº¡i";
    }

    let { password, email } = userData;
    //2. Hash Password
    password = hashPassword(password);
    //3. Generate code Ä‘á»ƒ gáº¯n vÃ o email
    let code = randomCode(100);

    //4. Táº¡o user vá»›i Ä‘áº§y Ä‘á»§ thÃ´ng tin code, vÃ  verify = false
    let user = await User.create({ ...userData, password, code });

    //5. Gá»­i email xÃ¡c nháº­n Ä‘Äƒng kÃ½ tÃ i khoáº£n, cÃ³ kÃ¨m link kÃ­ch hoáº¡t tÃ i khoáº£n
    await sendMail({
      from: '"Spacedev.vn ğŸ‘»" <study@spacedev.vn>', // sender address
      to: email, // list of receivers
      subject: "KÃ­ch hoáº¡t tÃ i khoáº£n spacedev.vn", // Subject line
      html: emailRegisterHtml, // html body
      data: {
        link: `http://localhost:8000/user/verify-register?code=${code}&email=${email}`,
      },
    });

    //6. Response thÃ´ng tin gá»­i mail thÃ nh cÃ´ng vá» client
    return user;
}
```

</details>

<details>
    <summary><h3 style="display: inline-block;">2. Viáº¿t api Ä‘Äƒng nháº­p</h3></summary>

#### YÃªu cáº§u:

1. Cho phÃ©p enabled / disabled khi thÃ´ng tin refreshToken bá»‹ lá»™
2. ÄÄƒng nháº­p vÄ©nh viá»…n

#### POST: `/login`

```json
{
    "email": "email", "required",
    "password": "string", "required" , "password rule",
}
```

#### Logic:

1. Hash password vÃ  tÃ¬m theo email vÃ  password Ä‘Æ°á»£c hash

2. Tráº£ lá»—i vá» client náº¿u khÃ´ng tÃ¬m tháº¥y, lÆ°u Ã½ khÃ´ng tráº£ vá» lá»—i cá»¥ thá»ƒ

3. Generate accessToken, refreshToken cÃ³ chá»©a user id

4. LÆ°u refreshToken vÃ o DB

5. Response vá» client accessToken, refreshToken
</details>
<details>
    <summary><h3 style="display: inline-block;">3. Viáº¿t api cáº­p nháº­t thÃ´ng tin cÃ¡ nhÃ¢n</h3></summary>

PATCH: `/update-info`

\*YÃªu cáº§u Authorization

```json
{
    "name": "string",
    "avatar": "string", "uri",
    "birthday": "date"
}
```

#### Logic:

1. Láº¥y thÃ´ng tin user tá»« Authorization header

2. Cáº­p nháº­t thÃ´ng tin cÃ³ trong body

3. Response vá» client thÃ´ng tin thÃ nh cÃ´ng / tháº¥t báº¡i
</details>
<details>
    <summary><h3 style="display: inline-block;">4. Viáº¿t api thay Ä‘á»•i máº­t kháº©u</h3></summary>

PATCH: `/change-password`

\*YÃªu cáº§u Authorization

```json
{
  "oldPassword": "password rule",
  "newpassword": "password rule"
}
```

#### Logic:

\*YÃªu cáº§u Authorization

1. ThÃªm field `changePasswordHistories = [{ password: String, changeAt: Date }]` vÃ o Model Ä‘á»ƒ lÆ°u thÃ´ng tin thay Ä‘á»•i máº­t kháº©u

2. Validate `oldPassword` vÃ  `newPassword`, yÃªu cáº§u khÃ´ng Ä‘Æ°á»£c giá»‘ng nhau

3. Kiá»ƒm tra thÃ´ng tin tÃ i khoáº£n vÃ  password cÅ©, náº¿u khÃ´ng Ä‘Ãºng thÃ¬ `throw Error`

4. Hash `newPassword` Kiá»ƒm tra `newPassword` cÃ³ náº±m trong nhá»¯ng password Ä‘Ã£ thay Ä‘á»•i trong khoáº£ng 6 thÃ¡ng gáº§n nháº¥t hay khÃ´ng, náº¿u cÃ³ thÃ¬ `throw Error`

5. LÆ°u password má»›i Ä‘Æ°á»£c hash vÃ o thÃ´ng tin user

6. ThÃªm vÃ o `changePasswordHistories` thÃ´ng tin password má»›i thay Ä‘á»•i vÃ  thá»i gian thay Ä‘á»•i

7. Response vá» client

</details>
<details>
    <summary><h3 style="display: inline-block;">5. Viáº¿t api tÃ¬m láº¡i máº­t kháº©u qua email</h3></summary>

PATCH: `/forgot-password`

```json
{
    "email": "required", "email",
    "redirect": "required" | "uri",
}
```

#### YÃªu cáº§u:

Giá»›i háº¡n khÃ´ng cho phÃ©p gá»­i mail liÃªn tá»¥c trong khoáº£ng 60s

#### Logic:

1. ThÃªm field `sendEmailAt = Date` Ä‘á»ƒ lÆ°u thá»i gian cuá»‘i cÃ¹ng gá»­i mail

1. TÃ¬m kiáº¿m user theo email, náº¿u khÃ´ng cÃ³ `throw Error` lá»—i "ÄÃ£ cÃ³ lá»—i xáº©y ra, vui lÃ²ng thá»­ láº¡i sau"

1. Kiá»ƒm tra thá»i gian gá»­i email cuá»‘i cÃ¹ng cÃ³ trong thá»i gian quy Ä‘á»‹nh, náº¿u < 60s thÃ¬ `throw Error` thÃ´ng bÃ¡o thá»i gian gá»­i mail

1. Gá»­i mail reset password cÃ³ `code` vÃ  link `redirect`

1. Cáº­p nháº­t thá»i gian gá»­i mail cuá»‘i cÃ¹ng `sendEmailAt`

1. Response vá» client thÃ´ng tin gá»­i mail thÃ nh cÃ´ng

</details>

# YÃªu cáº§u phi chá»©c nÄƒng (Non-functional requirement)

2. Cho phÃ©p enabled / disabled tá»«ng session cá»§a user, tÆ°Æ¡ng tá»± vá»›i refresh token
3. KhÃ´ng cho phÃ©p user thay Ä‘á»•i máº­t kháº©u thay Ä‘á»•i trong khoáº£ng 6 thÃ¡ng gáº§n nháº¥t
4. ÄÄƒng nháº­p vÄ©nh viá»…n
5. LÃ m 2 email template: register, reset password

# Chá»©c nÄƒng nÃ¢ng cao

1. ÄÄƒng kÃ½ / ÄÄƒng nháº­p thÃ´ng qua gmail, táº¡o máº­t kháº©u láº§n Ä‘áº§u tiÃªn khi user Ä‘Äƒng nháº­p
2. LÆ°u láº¡i lá»‹ch sá»­ Ä‘Äƒng nháº­p
3. Cho phÃ©p Ä‘Äƒng nháº­p trÃªn nhiá»u thiáº¿t bá»‹, enabled / disabled trÃªn tá»«ng thiáº¿t bá»‹
4. LÆ°u láº¡i láº§n Ä‘Äƒng nháº­p cuá»‘i trÃªn tá»«ng thiáº¿t bá»‹
5. Háº¡n cháº¿ sá»‘ láº§n nháº­p password sai, quÃ¡ 5 láº§n thÃ¬ pháº£i chá» 3 phÃºt má»›i Ä‘Äƒng nháº­p láº¡i
6. Khi thay Ä‘á»•i máº­t kháº©u, táº¥t cáº£ thiáº¿t bá»‹ Ä‘Ã£ tá»«ng Ä‘Äƒng nháº­p báº¯t buá»™c pháº£i Ä‘Äƒng nháº­p láº¡i
7. Chá»©c nÄƒng khÃ³a tÃ i khoáº£n
8. Chá»©c nÄƒng xÃ³a tÃ i khoáº£n: TÃ i khoáº£n sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o chá» xÃ³a, trong khoáº£ng thá»i gian chá» xÃ³a náº¿u Ä‘Äƒng nháº­p láº¡i thÃ¬ kÃ­ch hoáº¡t láº¡i tÃ i khoáº£n
9. Táº¡o mÃ£ Ä‘Äƒng nháº­p 1 láº§n
10. Báº£o máº­t 2 lá»›p (OTP qua email hoáº·c sá»‘ Ä‘iá»‡n thoáº¡i), cáº£nh bÃ¡o Ä‘Äƒng nháº­p trÃªn nhá»¯ng thiáº¿t bá»‹ láº¡
